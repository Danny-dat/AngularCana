<div class="user-page">
  <h2 class="page-title">Meine Daten</h2>

  @if (loading()) {
    <div class="card"><p>Lade…</p></div>
  } @else {
    @if (errorMsg()) {
      <div class="card error">{{ errorMsg() }}</div>
    }

    <!-- PROFIL -->
    <div class="card">
      <h3>Profil</h3>

      <div class="profile-layout">
        <div class="profile-edit">

      <div class="grid-2">
        <div class="setting-item">
          <label for="displayName">Anzeigename</label>
          <input id="displayName" type="text"
                 [formControl]="profileForm.controls.displayName"
                 (blur)="(profileForm.value.displayName ?? '').trim() && persistDisplayName((profileForm.value.displayName ?? '').trim())" />
        </div>

        <div class="setting-item">
          <label for="username">Username</label>
          <input id="username" type="text" placeholder="z.B. canna_ole"
                 [formControl]="profileForm.controls.username" />

          <div class="field-hint">
            @if (usernameState() === 'checking') {
              <span class="hint">prüfe…</span>
            } @else if (usernameState() === 'ok') {
              <span class="hint ok">verfügbar</span>
            } @else if (usernameState() === 'taken') {
              <span class="hint err">bereits vergeben</span>
            } @else if (usernameState() === 'invalid') {
              <span class="hint err">nur a-z, 0-9, _ (3–20)</span>
            }
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="setting-item">
          <label for="firstName">Vorname</label>
          <input id="firstName" type="text" [formControl]="profileForm.controls.firstName" />
        </div>

        <div class="setting-item">
          <label for="lastName">Nachname</label>
          <input id="lastName" type="text" [formControl]="profileForm.controls.lastName" />
        </div>
      </div>

      <div class="grid-2">
        <div class="setting-item">
          <label for="email">E-Mail</label>
          <input id="email" type="email" [formControl]="profileForm.controls.email" readonly />
          <div class="field-hint">
            <span class="hint">Hinweis: Login-E-Mail kann nur der User selbst ändern.</span>
          </div>
        </div>

        <div class="setting-item">
          <label for="phoneNumber">Telefonnummer</label>
          <input id="phoneNumber" type="tel" [formControl]="profileForm.controls.phoneNumber" />
        </div>
      </div>

      <div class="grid-2">
        <div class="setting-item">
          <label for="birthday">Geburtstag</label>
          <input id="birthday" type="date" [formControl]="profileForm.controls.birthday" />
        </div>

        <div class="setting-item">
          <label for="gender">Geschlecht</label>
          <select id="gender" [formControl]="profileForm.controls.gender">
            <option value="unspecified">Keine Angabe</option>
            <option value="male">Männlich</option>
            <option value="female">Weiblich</option>
            <option value="diverse">Divers</option>
          </select>
        </div>
      </div>

      <div class="setting-item">
        <label>Avatar</label>

        <div class="avatar-grid">
          <button type="button"
                  class="avatar-tile"
                  [class.active]="isAvatarSelected(null)"
                  (click)="selectAvatar(null)"
                  aria-label="Kein Avatar">
            <span class="avatar-none">—</span>
          </button>

          @for (a of avatarPresets; track a.id) {
            <button type="button"
                    class="avatar-tile"
                    [class.active]="isAvatarSelected(a.path)"
                    (click)="selectAvatar(a.path)"
                    [attr.aria-label]="a.label">
              <img [src]="a.path" alt="" loading="lazy" />
            </button>
          }
        </div>

        <div class="field-hint">
          <span class="hint">Spark Plan: kein Storage – Avatar wird aus Presets (assets) gewählt.</span>
        </div>
      </div>

      <div class="setting-item">
        <label for="bio">Bio</label>
        <textarea id="bio" rows="4" maxlength="280" [formControl]="profileForm.controls.bio"></textarea>
      </div>

      <div class="grid-2">
        <div class="setting-item">
          <label for="website">Website</label>
          <input id="website" type="url" placeholder="deine-seite.de"
                 [formControl]="profileForm.controls.website" />
        </div>
        <div class="setting-item">
          <label for="city">Stadt</label>
          <input id="city" type="text" [formControl]="profileForm.controls.city" />
        </div>
      </div>

      <div class="setting-item">
        <label for="country">Land</label>
        <input id="country" type="text" [formControl]="profileForm.controls.country" />
      </div>

      <details class="details">
        <summary>Social Links</summary>
        <div class="grid-2">
          <div class="setting-item">
            <label for="instagram">Instagram</label>
            <input id="instagram" type="text" placeholder="@name oder link" [formControl]="profileForm.controls.instagram" />
          </div>
          <div class="setting-item">
            <label for="tiktok">TikTok</label>
            <input id="tiktok" type="text" placeholder="@name oder link" [formControl]="profileForm.controls.tiktok" />
          </div>
        </div>
        <div class="grid-2">
          <div class="setting-item">
            <label for="youtube">YouTube</label>
            <input id="youtube" type="text" placeholder="Kanal oder link" [formControl]="profileForm.controls.youtube" />
          </div>
          <div class="setting-item">
            <label for="discord">Discord</label>
            <input id="discord" type="text" placeholder="name#1234" [formControl]="profileForm.controls.discord" />
          </div>
        </div>
        <div class="setting-item">
          <label for="telegram">Telegram</label>
          <input id="telegram" type="text" placeholder="@name" [formControl]="profileForm.controls.telegram" />
        </div>
      </details>

      <details class="details">
        <summary>Privatsphäre (öffentliche Ansicht)</summary>
        <div class="checklist">
          <label class="check">
            <input type="checkbox" [formControl]="profileForm.controls.showBio" />
            <span>Bio anzeigen</span>
          </label>
          <label class="check">
            <input type="checkbox" [formControl]="profileForm.controls.showWebsite" />
            <span>Website anzeigen</span>
          </label>
          <label class="check">
            <input type="checkbox" [formControl]="profileForm.controls.showLocation" />
            <span>Ort anzeigen</span>
          </label>
          <label class="check">
            <input type="checkbox" [formControl]="profileForm.controls.showSocials" />
            <span>Social Links anzeigen</span>
          </label>
        </div>
        <div class="field-hint">
          <span class="hint">Nur diese Felder werden in <code>profiles_public</code> gespiegelt.</span>
        </div>
      </details>

        </div>

        <div class="profile-preview">
          <h4>So sehen andere dich</h4>

          @let p = publicProfilePreview();

          <div class="preview-header">
            @if (p.photoURL) {
              <img class="preview-avatar" [src]="p.photoURL" alt="avatar" loading="lazy" />
            } @else {
              <div class="preview-avatar placeholder">?</div>
            }

            <div class="preview-title">
              <div class="preview-name">{{ p.displayName }}</div>
              @if (p.username) {
                <div class="preview-username">{{ p.username }}</div>
              }
            </div>
          </div>

          @if (p.bio) {
            <p class="preview-bio">{{ p.bio }}</p>
          }

          <div class="preview-meta">
            @if (p.locationText) {
              <div class="preview-row">
                <mat-icon fontSet="material-icons-outlined">place</mat-icon>
                <span>{{ p.locationText }}</span>
              </div>
            }
            @if (p.website) {
              <div class="preview-row">
                <mat-icon fontSet="material-icons-outlined">link</mat-icon>
                <a [href]="p.website" target="_blank" rel="noopener">{{ p.website }}</a>
              </div>
            }
          </div>

          @if (p.socials) {
            <div class="preview-socials">
              @if (p.socials.instagram) { <div class="preview-row"><span class="chip">Instagram</span><span>{{ p.socials.instagram }}</span></div> }
              @if (p.socials.tiktok) { <div class="preview-row"><span class="chip">TikTok</span><span>{{ p.socials.tiktok }}</span></div> }
              @if (p.socials.youtube) { <div class="preview-row"><span class="chip">YouTube</span><span>{{ p.socials.youtube }}</span></div> }
              @if (p.socials.discord) { <div class="preview-row"><span class="chip">Discord</span><span>{{ p.socials.discord }}</span></div> }
              @if (p.socials.telegram) { <div class="preview-row"><span class="chip">Telegram</span><span>{{ p.socials.telegram }}</span></div> }
            </div>
          }
        </div>
      </div>

      <!-- Profil speichern -->
      <button class="btn--primary btn btn-save"
              (click)="saveProfile()"
              [disabled]="savingProfile() || profileForm.invalid || profileForm.pristine">
        {{ savingProfile() ? 'Speichere…' : 'Profil speichern' }}
      </button>
    </div>

    <!-- DARSTELLUNG / EINSTELLUNGEN -->
    <div class="card">
      <h3>Darstellung & Einstellungen</h3>

      <div class="setting-item">
        <label>Theme</label>
        <div class="theme-selector">
          <button type="button"
                  [class.active]="settingsForm.value.theme === 'light'"
                  (click)="onThemeSelect('light')">
            <mat-icon fontSet="material-icons-outlined">light_mode</mat-icon> Hell
          </button>
          <button type="button"
                  [class.active]="settingsForm.value.theme === 'dark'"
                  (click)="onThemeSelect('dark')">
            <mat-icon fontSet="material-icons-outlined">dark_mode</mat-icon> Dunkel
          </button>
        </div>
      </div>

    <div class="setting-item">
      <label for="threshold">Tages-Limit (Beispiel)</label>
      <input
        id="threshold"
        type="number"
        min="0"
        max="20"
        step="1"
        [formControl]="settingsForm.controls.consumptionThreshold"
      />
    </div>

      <!-- Benachrichtigungssound -->
      <div class="setting-item setting-row">
        <div class="setting-text">
          <div class="setting-title">Benachrichtigungssound</div>
          <div class="setting-sub">Ton bei neuen Nachrichten abspielen</div>
        </div>

        <label class="switch">
          <input id="notifSound"
                 type="checkbox"
                 [formControl]="settingsForm.controls.notificationSound"
                 aria-label="Benachrichtigungssound ein- oder ausschalten" />
          <span class="slider"></span>
        </label>
      </div>

      <!-- Lautstärke -->
      <div class="setting-item">
        <label for="notifVol">Lautstärke</label>

        <div class="volume-row" [class.is-disabled]="settingsForm.value.notificationSound === false">
          <mat-icon class="vol-ico" fontSet="material-icons-outlined">volume_down</mat-icon>

          <input id="notifVol" type="range" min="0" max="100" step="1"
                [formControl]="settingsForm.controls.notificationVolumePct"
                (change)="$event.stopPropagation()" />

          <span class="volume-badge">
            {{ settingsForm.value.notificationVolumePct ?? 0 }}%
          </span>

          <button type="button"
                  class="btn btn-outline play-btn"
                  (click)="previewVolume()"
                  [disabled]="settingsForm.value.notificationSound === false">
            <mat-icon class="play-ico" fontSet="material-icons-outlined">play_arrow</mat-icon>
            Testen
          </button>
        </div>

        <div class="setting-hint">
          Tipp: Falls dein Browser Audio beim ersten Mal blockiert, einmal irgendwo klicken
          (z. B. auf die Glocke) und dann „Testen“ drücken.
        </div>
      </div>

      <!-- Einstellungen speichern -->
      <button class="btn--primary btn btn-save"
              (click)="saveSettings()"
              [disabled]="savingSettings() || settingsForm.invalid || !isSettingsChanged()">
        {{ savingSettings() ? 'Speichere…' : 'Einstellungen speichern' }}
      </button>
    </div>
  }
</div>
