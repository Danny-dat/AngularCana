<header class="ev-header">
  <h2>Events</h2>

  <div class="ev-actions">
    <div class="ev-search">
      <input
        type="search"
        placeholder="Suchen nach Name oder Adresse…"
        [value]="query()"
        (input)="query.set($any($event.target).value)"
        aria-label="Events durchsuchen" />
    </div>

    <label class="ev-toggle">
      <input
        type="checkbox"
        [checked]="onlyMine()"
        (change)="onlyMine.set($any($event.target).checked)" />
      <span>Nur meine Likes</span>
    </label>

    @if (uid()) {
      <div class="ev-stats"><span class="badge">Meine Likes: {{ likedCount() }}</span></div>
    }
  </div>
</header>

@if (filtered().length) {
  <ul class="ev-list">
    @for (e of filtered(); track e.id) {
      <li class="ev-card">
        <div class="ev-main">
          <div class="ev-title">{{ e.name }}</div>
          <div class="ev-sub">{{ e.address }}</div>

          <div class="ev-counters">
            <span class="chip chip-up" [class.me]="isUpvoted(e)">👍 {{ e.upvotes?.length || 0 }}</span>
            <span class="chip chip-down" [class.me]="isDownvoted(e)">👎 {{ e.downvotes?.length || 0 }}</span>
          </div>
        </div>

        <div class="ev-cta">
          <button
            class="btn up"
            [disabled]="pending()[e.id]"
            [class.active]="isUpvoted(e)"
            (click)="vote(e, 'up')"
            title="Gefällt mir">👍</button>

          <button
            class="btn down"
            [disabled]="pending()[e.id]"
            [class.active]="isDownvoted(e)"
            (click)="vote(e, 'down')"
            title="Gefällt mir nicht">👎</button>

          <button class="btn ghost" (click)="showOnMap(e)" title="Auf Karte zeigen">📍</button>
          <button class="btn ghost" (click)="openRoute(e)" title="Route öffnen">🧭</button>
        </div>
      </li>
    }
  </ul>
} @else {
  <div class="ev-empty">
    <div>Keine passenden Events gefunden.</div>
    <small>Tipp: Filter deaktivieren oder Suchbegriff ändern.</small>
  </div>
}

<!-- === Bestätigungs-Modal === -->
@if (confirmOpen()) {
  <div class="modal-backdrop" (click)="confirmCancel()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">Externe Karte öffnen</div>
      </div>

      <div class="modal-body">
        <p>Du verlässt jetzt die App. <strong>Google&nbsp;Maps</strong> wird in einem neuen Tab geöffnet.</p>

        @if (confirmEvent(); as ce) {
          <div class="modal-dest">
            <div class="dest-name">Ziel: {{ ce.name }}</div>
            <div class="dest-addr">{{ ce.address }}</div>
          </div>
        }

        <label class="noask">
          <input type="checkbox"
                 [checked]="dontAskAgain()"
                 (change)="dontAskAgain.set($any($event.target).checked)" />
          <span>In Zukunft nicht mehr fragen</span>
        </label>
      </div>

      <div class="modal-actions">
        <button class="btn outline" (click)="confirmCancel()">Abbrechen</button>
        <button class="btn primary" (click)="confirmProceed()">Öffnen</button>
      </div>
    </div>
  </div>
}
