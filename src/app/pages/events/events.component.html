<header class="ev-header">
  <h2>Events</h2>

  <div class="ev-actions">
    <div class="ev-search">
      <input
        type="search"
        placeholder="Suchen nach Name oder Adresse‚Ä¶"
        [value]="query()"
        (input)="query.set($any($event.target).value)"
        aria-label="Events durchsuchen" />
    </div>

    <label class="ev-toggle">
      <input
        type="checkbox"
        [checked]="onlyMine()"
        (change)="onlyMine.set($any($event.target).checked)" />
      <span>Nur meine Likes</span>
    </label>

    @if (uid()) {
      <div class="ev-stats"><span class="badge">Meine Likes: {{ likedCount() }}</span></div>
    }

    <button class="btn primary" (click)="openSuggest()" title="Event vorschlagen">
      + Vorschlagen
    </button>
  </div>
</header>

@if (filtered().length) {
  <ul class="ev-list">
    @for (e of filtered(); track e.id) {
      <li class="ev-card">
        <div class="ev-main">
          <div class="ev-title">{{ e.name }}</div>
          <div class="ev-sub">{{ e.address }}</div>

          <div class="ev-counters">
            <span class="chip chip-up" [class.me]="isUpvoted(e)">üëç {{ e.upvotes?.length || 0 }}</span>
            <span class="chip chip-down" [class.me]="isDownvoted(e)">üëé {{ e.downvotes?.length || 0 }}</span>
          </div>
        </div>

        <div class="ev-cta">
          <button
            class="btn up"
            [disabled]="pending()[e.id]"
            [class.active]="isUpvoted(e)"
            (click)="vote(e, 'up')"
            title="Gef√§llt mir">üëç</button>

          <button
            class="btn down"
            [disabled]="pending()[e.id]"
            [class.active]="isDownvoted(e)"
            (click)="vote(e, 'down')"
            title="Gef√§llt mir nicht">üëé</button>

          <button class="btn ghost" (click)="openRoute(e)" title="Route √∂ffnen">üß≠</button>
        </div>
      </li>
    }
  </ul>
} @else {
  <div class="ev-empty">
    <div>Keine passenden Events gefunden.</div>
    <small>Tipp: Filter deaktivieren oder Suchbegriff √§ndern.</small>
  </div>
}

<!-- === Vorschlag-Modal === -->
@if (suggestOpen()) {
  <div class="modal-backdrop" (click)="cancelSuggest()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">Event vorschlagen</div>
      </div>

      <div class="modal-body">
        <p>
          Gib Adresse + Datum/Uhrzeit an ‚Äì wir holen automatisch die Koordinaten dazu.
        </p>

        <div class="form-grid">
          <label>
            <span>Event-Name *</span>
            <input
              type="text"
              [value]="sName()"
              (input)="sName.set($any($event.target).value)"
              placeholder="z.B. Smoke Session am See" />
          </label>

          <label>
            <span>Stra√üe *</span>
            <input
              type="text"
              [value]="sStreet()"
              (input)="sStreet.set($any($event.target).value)"
              placeholder="z.B. Hauptstra√üe 12" />
          </label>

          <div class="two">
            <label>
              <span>PLZ (optional)</span>
              <input
                type="text"
                inputmode="numeric"
                [value]="sZip()"
                (input)="sZip.set($any($event.target).value)"
                placeholder="z.B. 10115" />
            </label>

            <label>
              <span>Stadt *</span>
              <input
                type="text"
                [value]="sCity()"
                (input)="sCity.set($any($event.target).value)"
                placeholder="z.B. Berlin" />
            </label>
          </div>

          <div class="two">
            <label>
              <span>Datum *</span>
              <input
                type="date"
                [value]="sDate()"
                (input)="sDate.set($any($event.target).value)" />
            </label>

            <label>
              <span>Uhrzeit *</span>
              <input
                type="time"
                [value]="sTime()"
                (input)="sTime.set($any($event.target).value)" />
            </label>
          </div>

          <div class="geo-tools">
            <button
              class="btn outline"
              type="button"
              (click)="checkAddress()"
              [disabled]="geoBusy() || suggestBusy()">
              @if (geoBusy()) { Suche‚Ä¶ } @else { Adresse pr√ºfen }
            </button>

            @if (geoError()) {
              <small class="geo-error">{{ geoError() }}</small>
            }
          </div>

          @if (geoResults().length === 1) {
            <div class="geo-ok">
              ‚úÖ Adresse gefunden: <strong>{{ geoResults()[0].label }}</strong>
              <div class="geo-sub"><code>{{ geoResults()[0].lat }}, {{ geoResults()[0].lng }}</code></div>
            </div>
          }

          @if (geoResults().length > 1) {
            <div class="geo-results">
              <div class="geo-title">Meintest du ‚Ä¶?</div>
              <div class="geo-list">
                @for (r of geoResults(); track $index) {
                  <label class="geo-item">
                    <input
                      type="radio"
                      name="geoPick"
                      [checked]="geoSelected() === $index"
                      (change)="pickGeo($index)" />
                    <span>{{ r.label }}</span>
                  </label>
                }
              </div>

              @if (geoSelected() >= 0) {
                <div class="geo-sub">
                  Ausgew√§hlt: <code>{{ geoResults()[geoSelected()].lat }}, {{ geoResults()[geoSelected()].lng }}</code>
                </div>
              }
            </div>
          }

          <label>
            <span>Notiz</span>
            <textarea
              rows="4"
              [value]="sNote()"
              (input)="sNote.set($any($event.target).value)"
              placeholder="Optional: Infos zum Ablauf / Details"></textarea>
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn outline" (click)="cancelSuggest()" [disabled]="suggestBusy()">Abbrechen</button>
        <button class="btn primary" (click)="submitSuggest()" [disabled]="suggestBusy()">
          @if (suggestBusy()) { Sende‚Ä¶ } @else { Abschicken }
        </button>
      </div>
    </div>
  </div>
}

<!-- === Best√§tigungs-Modal === -->
@if (confirmOpen()) {
  <div class="modal-backdrop" (click)="confirmCancel()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">Externe Karte √∂ffnen</div>
      </div>

      <div class="modal-body">
        <p>Du verl√§sst jetzt die App. <strong>Google&nbsp;Maps</strong> wird in einem neuen Tab ge√∂ffnet.</p>

        @if (confirmEvent(); as ce) {
          <div class="modal-dest">
            <div class="dest-name">Ziel: {{ ce.name }}</div>
            <div class="dest-addr">{{ ce.address }}</div>
          </div>
        }

        <label class="noask">
          <input type="checkbox"
                 [checked]="dontAskAgain()"
                 (change)="dontAskAgain.set($any($event.target).checked)" />
          <span>In Zukunft nicht mehr fragen</span>
        </label>
      </div>

      <div class="modal-actions">
        <button class="btn outline" (click)="confirmCancel()">Abbrechen</button>
        <button class="btn primary" (click)="confirmProceed()">√ñffnen</button>
      </div>
    </div>
  </div>
}
