<header class="ev-header">
  <h2>Events</h2>

  <div class="ev-actions">
    <div class="ev-search">
      <input
        type="search"
        placeholder="Suchen nach Name oder Adresseâ€¦"
        [value]="query()"
        (input)="query.set($any($event.target).value)"
        aria-label="Events durchsuchen" />
    </div>

    <label class="ev-toggle">
      <input
        type="checkbox"
        [checked]="onlyMine()"
        (change)="onlyMine.set($any($event.target).checked)" />
      <span>Nur meine Likes</span>
    </label>

    @if (uid()) {
      <div class="ev-stats"><span class="badge">Meine Likes: {{ likedCount() }}</span></div>
    }

    <button class="btn primary" (click)="openSuggest()" title="Event vorschlagen">
      + Vorschlagen
    </button>
  </div>
</header>

@if (filtered().length) {
  <ul class="ev-list">
    @for (e of filtered(); track e.id) {
      <li class="ev-card">
        <div class="ev-main">
          <div class="ev-title">{{ e.name }}</div>
          <div class="ev-sub">{{ e.address }}</div>

          <div class="ev-counters">
            <span class="chip chip-up" [class.me]="isUpvoted(e)">ğŸ‘ {{ e.upvotes?.length || 0 }}</span>
            <span class="chip chip-down" [class.me]="isDownvoted(e)">ğŸ‘ {{ e.downvotes?.length || 0 }}</span>
          </div>
        </div>

        <div class="ev-cta">
          <button
            class="btn up"
            [disabled]="pending()[e.id]"
            [class.active]="isUpvoted(e)"
            (click)="vote(e, 'up')"
            title="GefÃ¤llt mir">ğŸ‘</button>

          <button
            class="btn down"
            [disabled]="pending()[e.id]"
            [class.active]="isDownvoted(e)"
            (click)="vote(e, 'down')"
            title="GefÃ¤llt mir nicht">ğŸ‘</button>

          <button class="btn ghost" (click)="openRoute(e)" title="Route Ã¶ffnen">ğŸ§­</button>
        </div>
      </li>
    }
  </ul>
} @else {
  <div class="ev-empty">
    <div>Keine passenden Events gefunden.</div>
    <small>Tipp: Filter deaktivieren oder Suchbegriff Ã¤ndern.</small>
  </div>
}

<!-- === Vorschlag-Modal === -->
@if (suggestOpen()) {
  <div class="modal-backdrop" (click)="cancelSuggest()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">Event vorschlagen</div>
      </div>

      <div class="modal-body">
        <p>
          Schreib deinen Vorschlag hier rein â€“ die Admins bekommen automatisch eine Chat-Nachricht.
        </p>

        <div class="form-grid">
          <label>
            <span>Event-Name *</span>
            <input type="text" [value]="sName()" (input)="sName.set($any($event.target).value)" placeholder="z.B. Smoke Session am See" />
          </label>

          <label>
            <span>Adresse / Ort</span>
            <input type="text" [value]="sAddress()" (input)="sAddress.set($any($event.target).value)" placeholder="z.B. Berlin, Treptower Park" />
          </label>

          <div class="two">
            <label>
              <span>Lat (optional)</span>
              <input type="number" inputmode="decimal" [value]="sLat()" (input)="sLat.set($any($event.target).value)" placeholder="52.5" />
            </label>
            <label>
              <span>Lng (optional)</span>
              <input type="number" inputmode="decimal" [value]="sLng()" (input)="sLng.set($any($event.target).value)" placeholder="13.4" />
            </label>
          </div>

          <label>
            <span>Notiz</span>
            <textarea rows="4" [value]="sNote()" (input)="sNote.set($any($event.target).value)" placeholder="Was soll passieren? Wann ungefÃ¤hr? Besonderheiten?"></textarea>
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn outline" (click)="cancelSuggest()" [disabled]="suggestBusy()">Abbrechen</button>
        <button class="btn primary" (click)="submitSuggest()" [disabled]="suggestBusy()">
          @if (suggestBusy()) { Sendeâ€¦ } @else { Abschicken }
        </button>
      </div>
    </div>
  </div>
}

<!-- === BestÃ¤tigungs-Modal === -->
@if (confirmOpen()) {
  <div class="modal-backdrop" (click)="confirmCancel()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">Externe Karte Ã¶ffnen</div>
      </div>

      <div class="modal-body">
        <p>Du verlÃ¤sst jetzt die App. <strong>Google&nbsp;Maps</strong> wird in einem neuen Tab geÃ¶ffnet.</p>

        @if (confirmEvent(); as ce) {
          <div class="modal-dest">
            <div class="dest-name">Ziel: {{ ce.name }}</div>
            <div class="dest-addr">{{ ce.address }}</div>
          </div>
        }

        <label class="noask">
          <input type="checkbox"
                 [checked]="dontAskAgain()"
                 (change)="dontAskAgain.set($any($event.target).checked)" />
          <span>In Zukunft nicht mehr fragen</span>
        </label>
      </div>

      <div class="modal-actions">
        <button class="btn outline" (click)="confirmCancel()">Abbrechen</button>
        <button class="btn primary" (click)="confirmProceed()">Ã–ffnen</button>
      </div>
    </div>
  </div>
}
