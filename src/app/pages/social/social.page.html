<div class="social-shell">
  <!-- LEFT: Freunde -->
  <div class="col">
    <div class="card social-card">
      <div class="card-head">
        <div class="title">
          <h3>Freunde</h3>
          <div class="meta muted">
            <span>{{ filteredFriends().length }} gesamt</span>
            <span class="dot">•</span>
            <span>{{ onlineCount() }} online</span>
          </div>
        </div>

        <div class="search">
          <input
            class="input"
            [(ngModel)]="friendSearch"
            placeholder="Freunde suchen (Name oder ID)"
            autocomplete="off"
          />
        </div>
      </div>

      @if (!filteredFriends().length) {
        <div class="empty">
          Noch keine Freunde.
          <div class="muted" style="margin-top:6px; font-size:13px;">
            Nutze rechts „Freund hinzufügen“ und sende deinen Code.
          </div>
        </div>
      } @else {
        <div class="friends-list">
          @for (f of filteredFriends(); track f.id) {
            <div class="friend-row">
              <div class="left" (click)="openChat(f)" role="button" tabindex="0">
                <div class="avatar" [class.online]="isOnline(f.id)">
                  @if (f.photoURL) {
                    <img [src]="f.photoURL" alt="" />
                  } @else {
                    <div class="avatar-fallback">
                      {{ (f.username || f.displayName || f.label || f.id).slice(0, 1) }}
                    </div>
                  }
                  <span class="status-dot" [class.online]="isOnline(f.id)"></span>
                </div>

                <div class="names">
                  <div class="name">
                    {{ f.username || f.displayName || f.label || f.id }}
                    @if (isOnline(f.id)) {
                      <span class="chip online">online</span>
                    } @else {
                      <span class="chip">offline</span>
                    }
                  </div>
                  <div class="sub muted">ID: {{ f.id }}</div>
                </div>
              </div>

              <div class="right" (click)="$event.stopPropagation()">
                <button class="btn sm" (click)="goToProfile(f.id)">Profil</button>
                <button class="btn sm primary" (click)="openChat(f)">Chat</button>

                <select class="select" [(ngModel)]="f._action" (change)="handleAction(f)">
                  <option value="">Aktion…</option>
                  <option value="remove">Entfernen</option>
                  <option value="block">Blockieren</option>
                </select>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- RIGHT: Schnellaktionen / Anfragen / Blockierte -->
  <div class="col">
    <div class="card social-card">
      <h3>Schnellaktionen</h3>

      <!-- My Code -->
      <div class="section">
        <div class="section-head">
          <div>
            <div class="section-title">Dein Freundschaftscode</div>
            <div class="muted" style="font-size:13px;">Teile ihn mit Freund:innen</div>
          </div>
          <button class="btn sm ghost" (click)="toggleShareHelp()">?</button>
        </div>

        <div class="code-card">
          <code class="mono">{{ myCode }}</code>
          <div class="code-actions">
            <button class="btn sm" (click)="shareCopy($event)">Kopieren</button>
            <button class="btn sm" (click)="shareNative()">Teilen</button>
            <button class="btn sm" (click)="shareQR()">QR</button>
          </div>
        </div>

        @if (shareHelpOpen()) {
          <div class="hint-box">
            <b>Kopieren</b> legt den Code in die Zwischenablage.
            <b>Teilen</b> nutzt die Web-Share API.
            <b>QR</b> zeigt deinen Code als QR-Code.
          </div>
        }
      </div>

      <!-- Add Friend -->
      <div class="section">
        <div class="section-title">Freund hinzufügen</div>
        <div class="input-group">
          <input
            class="input"
            [(ngModel)]="friendCodeInput"
            (keyup.enter)="sendRequest()"
            placeholder="Freundschaftscode eingeben"
            autocomplete="off"
            inputmode="text"
          />
          <button class="btn sm primary" (click)="sendRequest()" [disabled]="!friendCodeInput().trim()">
            Senden
          </button>
        </div>
        <div class="muted" style="margin-top:6px; font-size:13px;">
          Tipp: Der Code ist einfach die UID. Du findest deinen Code oben.
        </div>
      </div>
    </div>

    <!-- Requests -->
    <div class="card social-card">
      <div class="card-head">
        <div class="title">
          <h3>Anfragen</h3>
          <div class="meta muted">
            <span>{{ incoming().length }} offen</span>
          </div>
        </div>
      </div>

      @if (!incoming().length) {
        <div class="empty">Keine offenen Anfragen.</div>
      } @else {
        <div class="requests-list">
          @for (r of incoming(); track r.id) {
            <div class="request-row">
              <div class="request-main">
                <div class="name">{{ r.fromDisplayName || r.fromEmail || r.fromUid }}</div>
                <div class="sub muted">ID: {{ r.fromUid }}</div>
              </div>
              <div class="actions">
                <button class="btn sm" (click)="goToProfile(r.fromUid)">Profil</button>
                <button class="btn sm success" (click)="accept(r)">Annehmen</button>
                <button class="btn sm danger" (click)="decline(r)">Ablehnen</button>
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Blocked -->
    <div class="card social-card">
      <div class="card-head">
        <div class="title">
          <h3>Blockiert</h3>
          <div class="meta muted">
            <span>{{ filteredBlocked().length }} Nutzer</span>
          </div>
        </div>

        <div class="search">
          <input
            class="input"
            [(ngModel)]="blockedSearch"
            placeholder="Blockierte suchen (Name oder ID)"
            autocomplete="off"
          />
        </div>
      </div>

      @if (!filteredBlocked().length) {
        <div class="empty">Noch keine blockierten Freunde.</div>
      } @else {
        <div class="blocked-list">
          @for (p of filteredBlocked(); track p.id) {
            <div class="blocked-row">
              <div class="left">
                <div class="avatar">
                  @if (p.photoURL) {
                    <img [src]="p.photoURL" alt="" />
                  } @else {
                    <div class="avatar-fallback">
                      {{ (p.username || p.displayName || p.label || p.id).slice(0, 1) }}
                    </div>
                  }
                </div>
                <div class="names">
                  <div class="name">{{ p.username || p.displayName || p.label || p.id }}</div>
                  <div class="sub muted">ID: {{ p.id }}</div>
                </div>
              </div>

              <div class="right">
                <button class="btn sm" (click)="goToProfile(p.id)">Profil</button>
                <button class="btn sm success" (click)="unblockDirectProfile(p)">Entblocken</button>
                <button class="btn sm danger" (click)="deleteBlockedProfile(p)">Löschen</button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>

<!-- QR-Overlay -->
@if (qrOpen()) {
  <div class="qr-overlay" (click)="closeQR()">
    <div class="qr-modal" (click)="$event.stopPropagation()">
      <h4>Freundschaftscode als QR</h4>
      @if (qrDataUrl()) {
        <img [src]="qrDataUrl()!" alt="QR-Code" class="qr-img" />
      }
      <div class="qr-actions">
        <button class="btn sm" (click)="downloadQR()">Download</button>
        <button class="btn sm" (click)="closeQR()">Schließen</button>
      </div>
    </div>
  </div>
}

<!-- Chat Overlay -->
@if (showChat()) {
  <app-chat-overlay
    [partner]="partner()"
    [messages]="messages()"
    [text]="chatInput()"
    (textChange)="chatInput.set($event)"
    [myUid]="user().uid"
    (report)="onReport($event)"
    (close)="closeChat()"
    (send)="sendMsg($event)"
  ></app-chat-overlay>
}
