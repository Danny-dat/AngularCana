<div class="page">
  <div class="header">
    <div class="title">
      <h2>Reports</h2>
      <div class="hint">In Bearbeitung zeigt nur die Reports, die dir zugewiesen wurden.</div>
    </div>

    <mat-form-field appearance="outline" class="search">
      <mat-label>Suche (UID / Text / ChatId)</mat-label>
      <input matInput [formControl]="searchCtrl" />
      <button matSuffix mat-icon-button *ngIf="searchCtrl.value" (click)="searchCtrl.setValue('')">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <ng-container *ngIf="vm$ | async as vm">
    <div class="board">
      <!-- OPEN ---------------------------------------------------------->
      <section class="col col-open">
        <div class="col-head">
          <div class="col-title">
            <span>Offen</span>
            <mat-chip class="count chip chip-new">{{ vm.open.length }}</mat-chip>
          </div>
          <div class="col-sub">Neu / noch nicht übernommen</div>
        </div>

        <div class="col-body">
          <ng-container *ngFor="let r of vm.open; trackBy: trackById">
            <div class="report-card">
              <div class="top">
                <div class="meta">
                  <span class="date">{{ r.createdAtDate ? (r.createdAtDate | date:'dd.MM.yyyy, HH:mm') : '—' }}</span>
                  <mat-chip class="chip chip-scope">{{ r.scopeLabel }}</mat-chip>
                  <mat-chip class="chip chip-new">{{ r.statusLabel }}</mat-chip>
                </div>

                <ng-container *ngIf="(admins$ | async) as admins">
                  <button mat-icon-button [matMenuTriggerFor]="rowMenu" title="Aktionen">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #rowMenu="matMenu">
                    <button mat-menu-item (click)="assignToMe(r)" [disabled]="r.statusFixed === 'resolved'">
                      <mat-icon>person</mat-icon>
                      <span>Mir zuweisen</span>
                    </button>

                    <button mat-menu-item [matMenuTriggerFor]="assignMenu" [disabled]="r.statusFixed === 'resolved' || !admins.length">
                      <mat-icon>person_add</mat-icon>
                      <span>Anderem Admin zuweisen…</span>
                    </button>

                    <mat-divider></mat-divider>

                    <button mat-menu-item (click)="markInReview(r)" [disabled]="r.statusFixed === 'resolved'">
                      <mat-icon>rule</mat-icon>
                      <span>In Bearbeitung</span>
                    </button>

                    <button mat-menu-item (click)="resolve(r)" [disabled]="r.statusFixed === 'resolved'">
                      <mat-icon>done</mat-icon>
                      <span>Erledigen</span>
                    </button>

                    <button mat-menu-item *ngIf="r.statusFixed === 'resolved'" (click)="reopen(r)">
                      <mat-icon>restart_alt</mat-icon>
                      <span>Wieder öffnen</span>
                    </button>
                  </mat-menu>

                  <mat-menu #assignMenu="matMenu">
                    <button mat-menu-item *ngFor="let a of admins" (click)="assignTo(r, a.uid)">
                      <mat-icon>person</mat-icon>
                      <span>{{ a.name }}<span *ngIf="a.email"> · {{ a.email }}</span></span>
                    </button>
                  </mat-menu>
                </ng-container>
              </div>

              <div class="who">
                <div class="who-item">
                  <div class="lbl">Reporter</div>
                  <ng-container *ngIf="(userInfo$(r.reporterId) | async) as u">
                    <a [routerLink]="['/admin/users', r.reporterId]" class="user" [title]="r.reporterId">
                      {{ u.name }} <code>{{ shortId(r.reporterId) }}</code>
                    </a>
                  </ng-container>
                </div>

                <mat-icon class="arrow">arrow_right_alt</mat-icon>

                <div class="who-item">
                  <div class="lbl">Gemeldet</div>
                  <ng-container *ngIf="(userInfo$(r.reportedId) | async) as u">
                    <a [routerLink]="['/admin/users', r.reportedId]" class="user" [title]="r.reportedId">
                      {{ u.name }} <code>{{ shortId(r.reportedId) }}</code>
                    </a>
                  </ng-container>
                </div>
              </div>

              <div class="reason">
                <b>{{ reasonLabel(r.reasonCategory) }}</b>
                <span class="sub" *ngIf="r.reasonText">· {{ r.reasonText }}</span>
              </div>

              <div class="msg" *ngIf="r.messageText" [title]="r.messageText">{{ r.messageText }}</div>

              <div class="subline" *ngIf="r.chatId">
                Chat: <code [title]="r.chatId">{{ shortId(r.chatId, 10, 6) }}</code>
                <span *ngIf="r.messageId">· msg: <code [title]="r.messageId">{{ shortId(r.messageId, 8, 6) }}</code></span>
              </div>
            </div>
          </ng-container>

          <div class="empty" *ngIf="vm.open.length === 0">
            Keine offenen Reports.
          </div>
        </div>
      </section>

      <!-- IN PROGRESS (ONLY ASSIGNED TO ME) ----------------------------->
      <section class="col col-progress">
        <div class="col-head">
          <div class="col-title">
            <span>In Bearbeitung</span>
            <mat-chip class="count chip chip-review">{{ vm.inProgress.length }}</mat-chip>
          </div>
          <div class="col-sub">Nur dir zugewiesen (Ticket-System)</div>
        </div>

        <div class="col-body">
          <ng-container *ngFor="let r of vm.inProgress; trackBy: trackById">
            <div class="report-card">
              <div class="top">
                <div class="meta">
                  <span class="date">{{ r.createdAtDate ? (r.createdAtDate | date:'dd.MM.yyyy, HH:mm') : '—' }}</span>
                  <mat-chip class="chip chip-scope">{{ r.scopeLabel }}</mat-chip>
                  <mat-chip class="chip chip-review">{{ r.statusLabel }}</mat-chip>
                </div>

                <ng-container *ngIf="(admins$ | async) as admins">
                  <button mat-icon-button [matMenuTriggerFor]="rowMenu" title="Aktionen">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #rowMenu="matMenu">
                    <button mat-menu-item (click)="assignToMe(r)" [disabled]="r.statusFixed === 'resolved'">
                      <mat-icon>person</mat-icon>
                      <span>Mir zuweisen</span>
                    </button>

                    <button mat-menu-item [matMenuTriggerFor]="assignMenu" [disabled]="r.statusFixed === 'resolved' || !admins.length">
                      <mat-icon>person_add</mat-icon>
                      <span>Anderem Admin zuweisen…</span>
                    </button>

                    <mat-divider></mat-divider>

                    <button mat-menu-item (click)="resolve(r)" [disabled]="r.statusFixed === 'resolved'">
                      <mat-icon>done</mat-icon>
                      <span>Erledigen</span>
                    </button>
                  </mat-menu>

                  <mat-menu #assignMenu="matMenu">
                    <button mat-menu-item *ngFor="let a of admins" (click)="assignTo(r, a.uid)">
                      <mat-icon>person</mat-icon>
                      <span>{{ a.name }}<span *ngIf="a.email"> · {{ a.email }}</span></span>
                    </button>
                  </mat-menu>
                </ng-container>
              </div>

              <div class="who">
                <div class="who-item">
                  <div class="lbl">Reporter</div>
                  <ng-container *ngIf="(userInfo$(r.reporterId) | async) as u">
                    <a [routerLink]="['/admin/users', r.reporterId]" class="user" [title]="r.reporterId">
                      {{ u.name }} <code>{{ shortId(r.reporterId) }}</code>
                    </a>
                  </ng-container>
                </div>

                <mat-icon class="arrow">arrow_right_alt</mat-icon>

                <div class="who-item">
                  <div class="lbl">Gemeldet</div>
                  <ng-container *ngIf="(userInfo$(r.reportedId) | async) as u">
                    <a [routerLink]="['/admin/users', r.reportedId]" class="user" [title]="r.reportedId">
                      {{ u.name }} <code>{{ shortId(r.reportedId) }}</code>
                    </a>
                  </ng-container>
                </div>
              </div>

              <div class="reason">
                <b>{{ reasonLabel(r.reasonCategory) }}</b>
                <span class="sub" *ngIf="r.reasonText">· {{ r.reasonText }}</span>
              </div>

              <div class="msg" *ngIf="r.messageText" [title]="r.messageText">{{ r.messageText }}</div>

              <div class="subline" *ngIf="r.assignedTo">
                Zugewiesen: <code [title]="r.assignedTo">{{ shortId(r.assignedTo) }}</code>
              </div>
            </div>
          </ng-container>

          <div class="empty" *ngIf="vm.inProgress.length === 0">
            Keine Reports in Bearbeitung für dich.
          </div>
        </div>
      </section>

      <!-- DONE ---------------------------------------------------------->
      <section class="col col-done">
        <div class="col-head">
          <div class="col-title">
            <span>Erledigt</span>
            <mat-chip class="count chip chip-resolved">{{ vm.done.length }}</mat-chip>
          </div>
          <div class="col-sub">Abgeschlossen</div>
        </div>

        <div class="col-body">
          <ng-container *ngFor="let r of vm.done; trackBy: trackById">
            <div class="report-card">
              <div class="top">
                <div class="meta">
                  <span class="date">{{ r.createdAtDate ? (r.createdAtDate | date:'dd.MM.yyyy, HH:mm') : '—' }}</span>
                  <mat-chip class="chip chip-scope">{{ r.scopeLabel }}</mat-chip>
                  <mat-chip class="chip chip-resolved">{{ r.statusLabel }}</mat-chip>
                </div>

                <ng-container *ngIf="(admins$ | async) as admins">
                  <button mat-icon-button [matMenuTriggerFor]="rowMenu" title="Aktionen">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #rowMenu="matMenu">
                    <button mat-menu-item (click)="reopen(r)">
                      <mat-icon>restart_alt</mat-icon>
                      <span>Wieder öffnen</span>
                    </button>
                  </mat-menu>
                </ng-container>
              </div>

              <div class="who">
                <div class="who-item">
                  <div class="lbl">Reporter</div>
                  <ng-container *ngIf="(userInfo$(r.reporterId) | async) as u">
                    <a [routerLink]="['/admin/users', r.reporterId]" class="user" [title]="r.reporterId">
                      {{ u.name }} <code>{{ shortId(r.reporterId) }}</code>
                    </a>
                  </ng-container>
                </div>

                <mat-icon class="arrow">arrow_right_alt</mat-icon>

                <div class="who-item">
                  <div class="lbl">Gemeldet</div>
                  <ng-container *ngIf="(userInfo$(r.reportedId) | async) as u">
                    <a [routerLink]="['/admin/users', r.reportedId]" class="user" [title]="r.reportedId">
                      {{ u.name }} <code>{{ shortId(r.reportedId) }}</code>
                    </a>
                  </ng-container>
                </div>
              </div>

              <div class="reason">
                <b>{{ reasonLabel(r.reasonCategory) }}</b>
                <span class="sub" *ngIf="r.reasonText">· {{ r.reasonText }}</span>
              </div>

              <div class="subline" *ngIf="r.resolutionNote">
                <b>Notiz:</b> {{ r.resolutionNote }}
              </div>
            </div>
          </ng-container>

          <div class="empty" *ngIf="vm.done.length === 0">
            Keine erledigten Reports.
          </div>
        </div>
      </section>
    </div>

    <ng-container *ngIf="vm.open.length + vm.inProgress.length + vm.done.length === 0">
      <div class="empty-global">
        <div class="empty-title">Keine Reports gefunden</div>
        <div class="empty-sub">Passe Suche an.</div>
      </div>
    </ng-container>
  </ng-container>
</div>
